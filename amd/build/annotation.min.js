define(["jquery","./global"],function(a,b){function c(){return this._instanceID=e(),this}var d=0,e=function(){return++d};return c.getInstanceCount=function(){return d},c.prototype.getInstanceID=function(){return this._instanceID},c.x=0,c.y=0,c.endx=0,c.endy=0,c.path="",c.toolid=0,c.colour="red",c.tooltype=null,c.id=0,c.cartridgex=0,c.cartridgey=0,c.adminDemo=0,c.prototype.init=function(a){this.cartridgex=parseInt(a.cartridgex,10)||0,this.cartridgey=parseInt(a.cartridgey,10)||0,this.colour=a.colour||"red",this.tooltype=a.tooltype,this.id=a.id,this.x=parseInt(a.x,10)||0,this.y=parseInt(a.y,10)||0,this.endx=parseInt(a.endx,10)||0,this.endy=parseInt(a.endy,10)||0,this.path=a.path||"",this.toolid=a.toolid},c.prototype.initAdminDemo=function(a){this.id="previsu_annot",this.displaylock=1,this.adminDemo=1,this.tooltype=a,this.colour=a.get_color()},c.prototype.draw=function(){},c.prototype.get_color=function(){var a=b.ANNOTATIONCOLOUR[this.colour];return a?(a=a.replace("rgb","rgba"),a=a.replace(")",",0.5)")):a=this.colour,a},c.prototype.get_color_cartridge=function(){var a=b.ANNOTATIONCOLOUR[this.tooltype.get_color_cartridge()];return a?(a=a.replace("rgb","rgba"),a=a.replace(")",",0.5)")):a=this.tooltype.get_color_cartridge(),a},c.prototype.init_div_cartridge_id=function(){var a=(new Date).toJSON().replace(/:/g,"").replace(/\./g,"");this.tooltype.id?this.divcartridge="ct_"+this.tooltype.id+"_"+a:this.divcartridge="ct_"+this.id+"_"+a},c.prototype.get_div_cartridge=function(b,c){var d="<div ";d+="id='"+this.divcartridge+"' ",d+="class='assignfeedback_editpdfplus_cartridge' ",d+="style='border-color: "+b+";position:relative;'> ",d+="</div>",c&&c.append(d);var e=a("#"+this.divcartridge);return this.adminDemo<1,e},c.prototype.get_div_cartridge_label=function(b,c){var d="<div ";d+="id='"+this.divcartridge+"_cartridge' ",d+="class='assignfeedback_editpdfplus_"+this.tooltype.getToolTypeLabel()+"_cartridge' ",d+="style='border-right-color: "+b+";color:"+b+";' ",d+="> ",d+=this.tooltype.cartridge,d+="</div>",c&&c.append(d);var e=a("#"+this.divcartridge+"_cartridge");return e},c.prototype.get_div_input=function(b,c){var d="<div ";d+="id='"+this.divcartridge+"_display' ",d+="style='color:"+b+"; ",d+="'></div>",c.append(d);var e=a("#"+this.divcartridge+"_display");return e.on("click",{annotation:this},this.edit_annot),e},c.prototype.get_div_edition=function(b){var c="<div ";c+="id='"+this.divcartridge+"_edit' ",c+="class='assignfeedback_editpdfplus_"+this.tooltype.getToolTypeLabel()+"_edition' ",c+="style='display:none;'> ",c+="<textarea id='"+this.divcartridge+"_editinput' type='text' class='form-control' style='margin-bottom:5px;'",1===this.adminDemo&&(c+=" readonly"),c+="></textarea>",c+="</div>",b&&b.append(c);var d=a("#"+this.divcartridge+"_edit"),e=this.tooltype.texts;if(e&&e.length>0){for(var f="<div class='btn-group-vertical aepp-toolbar-vertical'></div>",g=a(f),h=e.split('","'),i=0;i<h.length;i++){var j="<button class='btn btn-outline-dark'";1===this.adminDemo&&(j+=" disabled"),j+=" type='button'>"+h[i].replace(/"/g,"")+"</button>",g.append(j),this.adminDemo<1,g.append("<br/>")}d.append(g)}return d},c.prototype.get_div_container=function(b,c){var d="<div ";d+="class='assignfeedback_editpdfplus_"+this.tooltype.getToolTypeLabel()+"_conteneur' >",d+="</div>",c&&c.append(d);var e=a(".assignfeedback_editpdfplus_"+this.tooltype.getToolTypeLabel()+"_conteneur"),f=this.get_div_input(b,e);f.addClass("assignfeedback_editpdfplus_"+this.tooltype.getToolTypeLabel()+"_input");var g=1;(this.displaylock||this.displaylock>=0)&&(g=this.displaylock);var h="<input type='hidden' id='"+this.divcartridge+"_onof' value="+g+" />";return c&&e.append(h),e.append(this.get_input_question()),e},c.prototype.get_toolbar=function(){var b=a("<div id='"+this.divcartridge+"_toolbar' class='btn-group btn-group-sm aepp-toolbar'></div>");return b.append(this.get_button_visibility_left()),b.append(this.get_button_visibility_right()),b.append(this.get_button_save()),b.append(this.get_button_cancel()),1===this.tooltype.reply&&b.append(this.get_button_question()),b.append(this.get_button_remove()),b},c.prototype.get_input_question=function(){var a=0;return this.answerrequested&&1===this.answerrequested&&(a=1),"<input type='hidden' id='"+this.divcartridge+"_question' value='"+a+"'/>"},c.prototype.get_button_visibility_right=function(){var b="<button id='"+this.divcartridge+"_buttonedit_right' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=" type='button'>",b+="<i class='fa fa-arrow-right' aria-hidden='true'></i>",b+="</button>";var c=a(b);return this.adminDemo<1,c},c.prototype.get_button_visibility_left=function(){var b="<button id='"+this.divcartridge+"_buttonedit_left' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=" type='button'>",b+="<i class='fa fa-arrow-left' aria-hidden='true'></i>",b+="</button>";var c=a(b);return this.adminDemo<1,c},c.prototype.get_button_save=function(){var b="<button id='"+this.divcartridge+"_buttonsave' style='display:none;margin-left:110px;' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=" type='button'><i class='fa fa-check' aria-hidden='true'></i></button>";var c=a(b);return this.adminDemo<1&&c.on("click",this.save_annot),c},c.prototype.get_button_cancel=function(){var b="<button id='"+this.divcartridge+"_buttoncancel' style='display:none;' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=" type='button'><i class='fa fa-undo' aria-hidden='true'></i></button>";var c=a(b);return this.adminDemo<1,c},c.prototype.get_button_question=function(){var b="<button id='"+this.divcartridge+"_buttonquestion' style='display:none;margin-left:10px;' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=' type=\'button\'><span class="fa-stack fa-lg" style="line-height: 1em;width: 1em;"><i class="fa fa-question-circle-o fa-stack-1x"></i><i class="fa fa-ban fa-stack-1x text-danger"></i></span></button>';var c=a(b);return this.adminDemo<1,c},c.prototype.get_button_remove=function(){var b="<button id='"+this.divcartridge+"_buttonremove' style='display:none;margin-left:10px;' class='btn btn-sm btn-outline-dark'";1===this.adminDemo&&(b+=" disabled"),b+=" type='button'><i class='fa fa-trash' aria-hidden='true'></i></button>";var c=a(b);return this.adminDemo<1,c},c.prototype.apply_visibility_annot=function(){var b=a("#"+this.divcartridge+"_display"),c=a("#"+this.divcartridge+"_onof"),d=a("#"+this.divcartridge+"_buttonedit_right"),e=a("#"+this.divcartridge+"_buttonedit_left"),f=a("#"+this.divcartridge+"_radioContainer");c&&("1"===c.val()?(d&&d.show(),e&&e.show()):"0"===c.val()?(d&&d.show(),e&&e.hide()):(d&&d.hide(),e&&e.show())),b&&b.html(this.get_text_to_diplay_in_cartridge()),"frame"===this.tooltype.getToolTypeLabel()&&d&&(d.hide(),e.hide()),f&&f.hide(),this.apply_question_status()},c.prototype.get_text_to_diplay_in_cartridge=function(){var b=this.get_valref(),c=a("#"+this.divcartridge+"_onof"),d="";return""===b&&(d="&nbsp;&nbsp;&nbsp;&nbsp"),"1"===c.val()&&""!==b?d=b.substr(0,20):"0"===c.val()&&""!==b?d="...":""!==b&&(d=b),1===this.answerrequested&&(d+='&nbsp;<span style="color:red;">[?]</span>'),d},c.prototype.apply_question_status=function(){var b=a("#"+this.divcartridge+"_buttonquestion"),c=a("#"+this.divcartridge+"_question"),d=0;c&&(d=parseInt(c.val(),10)),b&&(1===d?b.html('<i class="fa fa-question-circle-o"></i>'):b.html('<span class="fa-stack fa-lg" style="line-height: 1em;width: 1em;"><i class="fa fa-question-circle-o fa-stack-1x"></i><i class="fa fa-ban fa-stack-1x text-danger"></i></span>'))},c.prototype.draw_catridge=function(){return!0},c.prototype.edit_annot=function(c){if(c.data.annotation.tooltype.typetool<=b.TOOLTYPE.COMMENTPLUS){var d=c.data.annotation,e=a("#"+d.divcartridge),f=a("#"+d.divcartridge+"_display"),g=a("#"+d.divcartridge+"_edit"),h=a("#"+d.divcartridge+"_buttonedit_right"),i=a("#"+d.divcartridge+"_buttonedit_left"),j=a("#"+d.divcartridge+"_buttonsave"),k=a("#"+d.divcartridge+"_buttoncancel"),l=a("#"+d.divcartridge+"_buttonquestion"),m=a("#"+d.divcartridge+"_buttonrotation"),n=a("#"+d.divcartridge+"_buttonremove"),o=a("#"+d.divcartridge+"_editinput");f.hide(),h&&h.hide(),i&&i.hide(),m&&m.hide(),g.show(),j.show(),k.show(),l&&l.show(),n.show(),e.css("z-index",1e3),o&&o.attr("focus","on"),c.data.annotation.disabled_canvas_event(),a("#canevas").on("click",{annotation:d,action:"clickoutside"},d.save_annot_clickout)}},c.prototype.fill_input_edition=function(b,c){var d=a("#"+this.divcartridge+"_editinput");d&&d.set("value",c),this.save_annot(c)},c.prototype.save_annot_clickout=function(a){"canevas"===a.target.id&&1===a.data.annotation.adminDemo&&a.data.annotation.cancel_edit()},c.prototype.save_annot=function(b){if("string"!=typeof b){var c=a("#"+this.divcartridge+"_editinput");c&&(b=c.val())}this.textannot=b,0===b.length&&(b="&nbsp;&nbsp;"),this.hide_edit(),this.apply_visibility_annot()},c.prototype.cancel_edit=function(){var b=this.get_valref(),c=a("#"+this.divcartridge+"_editinput");b&&c&&c.set("value",b),this.hide_edit(),this.apply_visibility_annot();var d=a("#"+this.divcartridge);d&&d.off()},c.prototype.hide_edit=function(b,c){if(!c||"clickoutside"!==c||this.editor.currentannotation!==this){var d=a("#"+this.divcartridge),e=a("#"+this.divcartridge+"_display"),f=a("#"+this.divcartridge+"_edit"),g=a("#"+this.divcartridge+"_visu"),h=a("#"+this.divcartridge+"_buttonsave"),i=a("#"+this.divcartridge+"_buttoncancel"),j=a("#"+this.divcartridge+"_buttonquestion"),k=a("#"+this.divcartridge+"_buttonrotation"),l=a("#"+this.divcartridge+"_buttonremove"),m=a("#"+this.divcartridge+"_radioContainer");e&&(e.show(),e.css("color",this.get_color_cartridge())),k&&k.show(),f&&(f.hide(),h.hide(),i.hide()),g&&g.hide(),j&&j.hide(),l&&l.hide(),d&&(d.css("z-index",1),a("#canevas").off()),f&&this.enabled_canvas_event(),m&&m.hide()}},c.prototype.disabled_canvas_event=function(){var c=a(b.SELECTOR.DRAWINGCANVAS);c.off("click")},c.prototype.enabled_canvas_event=function(){},c.prototype.change_visibility_annot=function(b){var c=a("#"+this.divcartridge+"_onof"),d=parseInt(c.val(),10);"r"===b?d+=1:d-=1,c.val(d),this.displaylock=d,this.apply_visibility_annot()},c.prototype.get_valref=function(){return this.textannot&&this.textannot.length>0&&"string"==typeof this.textannot?this.textannot:""},c});